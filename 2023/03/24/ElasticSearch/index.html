

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="swt">
  <meta name="keywords" content="">
  
    <meta name="description" content="1、ElasticSearch基本概念（1）Node节点 一个节点是一个集群的服务器，存储集群的数据，参与集群的索引和搜索功能。像集群有名字，节点也有自己的名称，默认在启动时会以一个随机的UUID的前七个字符作为节点的名字，你可以为其指定任意的名字。通过集群名在网络中发现同伴组成集群。一个节点也可是集群。  （2）index索引 一个索引是文档的集合，类比mysql中的数据库，每个索引有唯一名称（">
<meta property="og:type" content="article">
<meta property="og:title" content="ElasticSearch">
<meta property="og:url" content="http://example.com/2023/03/24/ElasticSearch/index.html">
<meta property="og:site_name" content="SWT博客">
<meta property="og:description" content="1、ElasticSearch基本概念（1）Node节点 一个节点是一个集群的服务器，存储集群的数据，参与集群的索引和搜索功能。像集群有名字，节点也有自己的名称，默认在启动时会以一个随机的UUID的前七个字符作为节点的名字，你可以为其指定任意的名字。通过集群名在网络中发现同伴组成集群。一个节点也可是集群。  （2）index索引 一个索引是文档的集合，类比mysql中的数据库，每个索引有唯一名称（">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/1.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/2.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/3.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/4.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/5.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/6.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/7.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/8.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/9.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/10.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/11.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/12.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/13.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/14.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/15.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/16.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/17.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/18.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/19.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/20.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/21.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/22.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/23.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/24.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/25.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/26.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/27.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/28.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/29.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/30.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/31.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/32.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/33.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/34.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/35.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/36.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/37.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/38.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/39.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/40.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/41.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/42.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/43.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/44.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/45.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/46.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/47.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/48.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/49.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/50.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/51.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/52.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/53.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/54.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/55.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/56.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/57.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/58.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/59.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/60.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/61.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/62.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/63.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/64.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/65.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/66.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/67.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/68.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/69.png">
<meta property="og:image" content="http://example.com/2023/03/24/ElasticSearch/70.png">
<meta property="article:published_time" content="2023-03-24T02:17:24.000Z">
<meta property="article:modified_time" content="2023-04-13T03:50:11.587Z">
<meta property="article:author" content="swt">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="http://example.com/2023/03/24/ElasticSearch/1.png">
  
  
  
  <title>ElasticSearch - SWT博客</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"example.com","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Fluid</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="ElasticSearch"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2023-03-24 10:17" pubdate>
          2023年3月24日 上午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          9k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          75 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">ElasticSearch</h1>
            
            
              <div class="markdown-body">
                
                <h3 id="1、ElasticSearch基本概念"><a href="#1、ElasticSearch基本概念" class="headerlink" title="1、ElasticSearch基本概念"></a>1、ElasticSearch基本概念</h3><h4 id="（1）Node节点"><a href="#（1）Node节点" class="headerlink" title="（1）Node节点"></a>（1）Node节点</h4><blockquote>
<p>一个节点是一个集群的服务器，存储集群的数据，参与集群的索引和搜索功能。像集群有名字，节点也有自己的名称，默认在启动时会以一个随机的UUID的前七个字符作为节点的名字，你可以为其指定任意的名字。通过集群名在网络中发现同伴组成集群。一个节点也可是集群。</p>
</blockquote>
<h4 id="（2）index索引"><a href="#（2）index索引" class="headerlink" title="（2）index索引"></a>（2）index索引</h4><blockquote>
<p>一个索引是文档的集合，类比mysql中的数据库，每个索引有唯一名称（全为小写字母），我们对文档进行搜索，增删改时，都要用到这个名字。</p>
</blockquote>
<h4 id="（3）Type类型"><a href="#（3）Type类型" class="headerlink" title="（3）Type类型"></a>（3）Type类型</h4><blockquote>
<p>一个索引中可以存放不同数据，类比mysql中的表，6.0版本以上已废弃。</p>
</blockquote>
<h4 id="（4）Document文档"><a href="#（4）Document文档" class="headerlink" title="（4）Document文档"></a>（4）Document文档</h4><blockquote>
<p>索引中的一条数据，类比msql中的一行数据，插入索引以文档为单位，以JSON格式存储。</p>
</blockquote>
<h4 id="（5）Shard分片"><a href="#（5）Shard分片" class="headerlink" title="（5）Shard分片"></a>（5）Shard分片</h4><blockquote>
<p>数据量过大时，ElasticSearch索引过慢，因此将索引划分成多份，这些份就是分片。分片允许水平扩容；同时支持分布式，并行操作。</p>
</blockquote>
<h4 id="（6）Replication复制"><a href="#（6）Replication复制" class="headerlink" title="（6）Replication复制"></a>（6）Replication复制</h4><blockquote>
<p>一个分片可以有多个备份，分片和复制的数量可以在索引创建的时候指定。在索引创建之后，你可以在任何时候动态地改变复制的数量，但是你事后不能改变分片的数量。</p>
</blockquote>
<h3 id="2、索引"><a href="#2、索引" class="headerlink" title="2、索引"></a>2、索引</h3><h4 id="（1）索引创建"><a href="#（1）索引创建" class="headerlink" title="（1）索引创建"></a>（1）索引创建</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs json">PUT /test-index-users<br><span class="hljs-punctuation">&#123;</span><br>  <span class="hljs-attr">&quot;settings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;number_of_shards&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><span class="hljs-comment">//设置分片数量</span><br>    <span class="hljs-attr">&quot;number_of_replicas&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>  <span class="hljs-comment">//指定映射关系</span><br>  <span class="hljs-attr">&quot;mappings&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;properties&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>      <span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;fields&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>          <span class="hljs-attr">&quot;keyword&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>            <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;keyword&quot;</span><span class="hljs-punctuation">,</span><br>            <span class="hljs-attr">&quot;ignore_above&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">256</span><br>          <span class="hljs-punctuation">&#125;</span><br>        <span class="hljs-punctuation">&#125;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;long&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><br>      <span class="hljs-attr">&quot;remarks&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;type&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;text&quot;</span><br>      <span class="hljs-punctuation">&#125;</span><br>    <span class="hljs-punctuation">&#125;</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h4 id="（2）倒排索引"><a href="#（2）倒排索引" class="headerlink" title="（2）倒排索引"></a>（2）倒排索引</h4><blockquote>
<p>ElasticSearch会为下面的数据创建两个索引树，ID不指定会自动生成，以Name和Age生成的索引树就为倒排索引</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">ID</th>
<th align="center">Name</th>
<th align="center">Age</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">Kate</td>
<td align="center">24</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">John</td>
<td align="center">24</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">Bill</td>
<td align="center">29</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">Kate</td>
<td align="center">26</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center">Brand</td>
<td align="center">29</td>
</tr>
</tbody></table>
<blockquote>
<p>以Name字段建立的索引树</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">Term</th>
<th align="center">Posting List</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Kate</td>
<td align="center">1,4</td>
</tr>
<tr>
<td align="center">Brand</td>
<td align="center">5</td>
</tr>
<tr>
<td align="center">John</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">Bill</td>
<td align="center">3</td>
</tr>
</tbody></table>
<blockquote>
<p>以Age创建索引树</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">Term</th>
<th align="center">Posting List</th>
</tr>
</thead>
<tbody><tr>
<td align="center">24</td>
<td align="center">1,2</td>
</tr>
<tr>
<td align="center">26</td>
<td align="center">4</td>
</tr>
<tr>
<td align="center">29</td>
<td align="center">3,5</td>
</tr>
</tbody></table>
<blockquote>
<p>①每个字段对应一组Term，每个Term对应一个Posting List，他是一组id，根据id到磁盘查找速度会快很多；</p>
<p>②Term存放于有序表Term DIctionary（磁盘中）中，Term按序存放，每次查找term时，根据二分查找，时间复杂度为LogN；</p>
<p>③对于Term中大量重复前缀，ElasticSearch会把每一个Term的前缀取出来放入树种，这颗树就是Term Index。</p>
</blockquote>
<img src="/2023/03/24/ElasticSearch/1.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<blockquote>
<p>Posting List压缩：</p>
<p>①bitmap是一种数据结构，其用0&#x2F;1代表值是否存在，如</p>
<p>{1，2，3，5},对应bitmap为：[1，0，1，1，1]</p>
<p>②但bitmap随着元素的增加，bitmap存储空间也是线性增加，会占用大量空间；</p>
<p>③Roardings bitmap：</p>
<p>将posting List按照65535分块，0-65535为第一块，65536-131071为第二块，再用&lt;商，余数&gt;表示一组id，商表示在第几组，余数则表示在组中位置，如下图：</p>
</blockquote>
<img src="/2023/03/24/ElasticSearch/2.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<h3 id="3、DSL查询"><a href="#3、DSL查询" class="headerlink" title="3、DSL查询"></a>3、DSL查询</h3><blockquote>
<ul>
<li>match查询，会将查询池进行分词，包含分词后的词，数据可以被查到，如：</li>
</ul>
<p>查询词：苹果橘子，只要包含苹果、橘子的文档都会被查出</p>
<ul>
<li>term查询，需要包含和查询值一样的文档，数据才可以被查到（查询词若为英文单词，全部字母需要小写，否则匹配不到），如：</li>
</ul>
<p>数据：【Apple ，oragne】，查询词：apple  可以被查到的数据：Apple</p>
</blockquote>
<h4 id="（1）复合查询"><a href="#（1）复合查询" class="headerlink" title="（1）复合查询"></a>（1）复合查询</h4><h6 id="①布尔查询（bool-query）"><a href="#①布尔查询（bool-query）" class="headerlink" title="①布尔查询（bool query）"></a>①布尔查询（bool query）</h6><blockquote>
<ul>
<li>子查询可以任意顺序出现</li>
<li>可以嵌套多个查询，包括bool查询</li>
<li>如果bool查询中没有must条件，should中必须至少满足一条才会返回结果，不满足不反回数据。</li>
<li>四种操作符must、should、must_not、filter</li>
</ul>
</blockquote>
<img src="/2023/03/24/ElasticSearch/3.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<blockquote>
<p>must与filter区别</p>
</blockquote>
<img src="/2023/03/24/ElasticSearch/4.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<h6 id="②提高查询（boosting-query）"><a href="#②提高查询（boosting-query）" class="headerlink" title="②提高查询（boosting query）"></a>②提高查询（boosting query）</h6><blockquote>
<p>boosting查询中一个子查询条件不满足，则是减低数据显示的权重（score），如</p>
<p>name&#x3D;”tom” and age&#x3D;1,条件age不匹配，数据还是会显示，只是降低权重（scope）</p>
</blockquote>
<img src="/2023/03/24/ElasticSearch/5.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<h6 id="③固定分数查询（constant-scope）"><a href="#③固定分数查询（constant-scope）" class="headerlink" title="③固定分数查询（constant_scope）"></a>③固定分数查询（constant_scope）</h6><blockquote>
<p>查询某个条件时，返回固定的scope，我们可以利用filter过滤，返回scope，不需要计算scope，filter是忽略scope的</p>
</blockquote>
<img src="/2023/03/24/ElasticSearch/6.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<h6 id="④最佳匹配查询（dis-max）"><a href="#④最佳匹配查询（dis-max）" class="headerlink" title="④最佳匹配查询（dis_max）"></a>④最佳匹配查询（dis_max）</h6><blockquote>
<p>将与任一匹配的文档返回，但只返回结果最佳的评分 作为查询的评分返回</p>
<p>在使用多个match匹配时，<u>匹配度最高的不一定是最佳结果</u>，因为match匹配时，会将title，body中match匹配结果的评分进行累加，最终返回，下面计算评分:</p>
<ol>
<li>通过title 匹配 brown fox ，id&#x3D;1匹配到(第一个match)</li>
</ol>
<p>id&#x3D;1分数：0.6931472</p>
<p>id&#x3D;2分数：0</p>
<img src="/2023/03/24/ElasticSearch/7.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<p>2.body 匹配 brown fox（第二个match）</p>
<p>id&#x3D;1分数：0.2111090919</p>
<p>id&#x3D;2分数：0.77041256</p>
<img src="/2023/03/24/ElasticSearch/8.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<p>3.整体查询的结果分数&#x3D;第一个match分数+第二个match分数</p>
<p>id为1的分数&#x3D;0.6931472+0.2111090919&#x3D;0.90425634</p>
<p>id为2的分数&#x3D;0+0.77041256&#x3D;0.77041256</p>
<img src="/2023/03/24/ElasticSearch/9.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<p>使用dis_max,   分数 &#x3D; 第一个匹配条件分数 + tie_breaker * 第二个匹配的条件的分数 </p>
<img src="/2023/03/24/ElasticSearch/10.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="⑤函数查询（function-score）"><a href="#⑤函数查询（function-score）" class="headerlink" title="⑤函数查询（function_score）"></a>⑤函数查询（function_score）</h6><blockquote>
<p>使用自定义的函数计算评分值</p>
<ul>
<li>script_score 使用自定义的脚本来完全控制分值计算逻辑。如果你需要以上预定义函数之外的功能，可以根据需要通过脚本进行实现。</li>
</ul>
<img src="/2023/03/24/ElasticSearch/11.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<ul>
<li>weight 对每份文档适用一个简单的提升，且该提升不会被归约：当weight为2时，结果为2 * score。</li>
<li>random_score 使用一致性随机分值计算来对每个用户采用不同的结果排序方式，对相同用户仍然使用相同的排序方式。</li>
</ul>
<img src="/2023/03/24/ElasticSearch/12.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<ul>
<li>field_value_factor 使用文档中某个字段的值来改变_score，比如将受欢迎程度或者投票数量考虑在内。</li>
</ul>
<img src="/2023/03/24/ElasticSearch/13.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<ul>
<li>衰减函数(Decay Function) - linear，exp，gauss</li>
</ul>
</blockquote>
<h4 id="（2）全文搜索"><a href="#（2）全文搜索" class="headerlink" title="（2）全文搜索"></a>（2）全文搜索</h4><h6 id="①match查询"><a href="#①match查询" class="headerlink" title="①match查询"></a>①match查询</h6><blockquote>
<p><strong>单词匹配</strong></p>
<p>（1）检查查询字段类型，字段为string类型，则match匹配的词要进行分词；</p>
<p>（2）分析查询字符串，下图中quick只有一个单词，分词后结果为quic，所以match执行的是当个term查询</p>
<p>（3）term通过倒排索引。，查询到id为 【1，3】</p>
<p>（4）为每个查询结果进行评分</p>
<img src="/2023/03/24/ElasticSearch/14.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<blockquote>
<p><strong>多词匹配</strong></p>
<p>多个单词，实际上是执行多个单词term匹配，然后合并结果</p>
<img src="/2023/03/24/ElasticSearch/15.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<p>上方查询与下方bool查询等价</p>
<img src="/2023/03/24/ElasticSearch/16.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<p>match多词匹配中，有个operator属性，默认值为or，结果与上面等价</p>
<img src="/2023/03/24/ElasticSearch/17.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<p>match支持参数minimum_should_match来控制匹配单词数，可以是分数，也可以直接指定匹配单词数</p>
<img src="/2023/03/24/ElasticSearch/18.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<img src="/2023/03/24/ElasticSearch/19.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="②match-phrase查询"><a href="#②match-phrase查询" class="headerlink" title="②match_phrase查询"></a>②match_phrase查询</h6><blockquote>
<p>本质是连续的term查询（必须满足所有单词匹配），遇到数据中没有的词，就会查询不到，同时搜索单词的顺序需要和数据中单词顺寻保持一致，否则查询不到；如下：</p>
<img src="/2023/03/24/ElasticSearch/20.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<p>下面匹配单词和上图一样，但是顺寻不一样，匹配结果不同</p>
<img src="/2023/03/24/ElasticSearch/21.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="③match-pharse-prefix"><a href="#③match-pharse-prefix" class="headerlink" title="③match_pharse_prefix"></a>③match_pharse_prefix</h6><blockquote>
<p>该匹配是最后一个词是前缀匹配，前面的单词和match_pharse匹配一致，如：</p>
<p>【brown quick f】需要匹配到单词brown、quick，且以f为前缀的单词，同时顺序需要保持一致；</p>
<img src="/2023/03/24/ElasticSearch/22.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<img src="/2023/03/24/ElasticSearch/23.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="④match-bool-prefix"><a href="#④match-bool-prefix" class="headerlink" title="④match_bool_prefix"></a>④match_bool_prefix</h6><blockquote>
<p>也是连续的term匹配，最后一个单词前缀匹配即可，需要匹配所有单词，但顺序可以不一致，如下图：</p>
<img src="/2023/03/24/ElasticSearch/24.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="⑤multi-match"><a href="#⑤multi-match" class="headerlink" title="⑤multi_match"></a>⑤multi_match</h6><blockquote>
<p>查询单词，满足其中一个字段即可，不用所有单词都匹配</p>
<img src="/2023/03/24/ElasticSearch/25.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<img src="/2023/03/24/ElasticSearch/26.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="⑥query-string"><a href="#⑥query-string" class="headerlink" title="⑥query_string"></a>⑥query_string</h6><blockquote>
<p>根据运算符来来提供查询字符串，查询前，拆分每一个文本</p>
<img src="/2023/03/24/ElasticSearch/27.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="⑦simple-query-string"><a href="#⑦simple-query-string" class="headerlink" title="⑦simple_query_string"></a>⑦simple_query_string</h6><blockquote>
<p>查询时，会自动将搜索词中无效的文本忽略</p>
<img src="/2023/03/24/ElasticSearch/28.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="⑧interval"><a href="#⑧interval" class="headerlink" title="⑧interval"></a>⑧interval</h6><blockquote>
<p>单词都要匹配，且按照匹配条件顺序进行匹配</p>
<img src="/2023/03/24/ElasticSearch/29.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h4 id="（3）Term查询"><a href="#（3）Term查询" class="headerlink" title="（3）Term查询"></a>（3）Term查询</h4><h6 id="①exist查询"><a href="#①exist查询" class="headerlink" title="①exist查询"></a>①exist查询</h6><blockquote>
<p>查询指定字段存在的数据，字段索引值不存在的原因：JSON数据为null、index设置为false、字段长度超过映射长度、字段数据类型错误</p>
<img src="/2023/03/24/ElasticSearch/30.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="②id查询"><a href="#②id查询" class="headerlink" title="②id查询"></a>②id查询</h6><blockquote>
<p>查询指定id的数据</p>
<img src="/2023/03/24/ElasticSearch/31.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="③prefix前缀查询"><a href="#③prefix前缀查询" class="headerlink" title="③prefix前缀查询"></a>③prefix前缀查询</h6><blockquote>
<p>查找指定字段的前缀值相同的数据</p>
<img src="/2023/03/24/ElasticSearch/32.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="④term分词查询"><a href="#④term分词查询" class="headerlink" title="④term分词查询"></a>④term分词查询</h6><blockquote>
<p>根据分词查询数据，查询词需要和value值完全一样才会匹配</p>
<img src="/2023/03/24/ElasticSearch/33.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="⑤terms多分词查询"><a href="#⑤terms多分词查询" class="headerlink" title="⑤terms多分词查询"></a>⑤terms多分词查询</h6><blockquote>
<p>根据多个分词查询数据</p>
<img src="/2023/03/24/ElasticSearch/34.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="⑥term-set查询"><a href="#⑥term-set查询" class="headerlink" title="⑥term_set查询"></a>⑥term_set查询</h6><blockquote>
<p>指定term需要匹配词的数量</p>
<img src="/2023/03/24/ElasticSearch/35.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="⑦wildcard查询"><a href="#⑦wildcard查询" class="headerlink" title="⑦wildcard查询"></a>⑦wildcard查询</h6><blockquote>
<p>通配符查询，如*可以匹配任意多个随意在字符</p>
<img src="/2023/03/24/ElasticSearch/36.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="⑧range查询"><a href="#⑧range查询" class="headerlink" title="⑧range查询"></a>⑧range查询</h6><blockquote>
<p>范围匹配查询</p>
<img src="/2023/03/24/ElasticSearch/37.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="⑩fuzzy模糊查询"><a href="#⑩fuzzy模糊查询" class="headerlink" title="⑩fuzzy模糊查询"></a>⑩fuzzy模糊查询</h6><blockquote>
<p>模糊查询，可以进行匹配词的增删改，如增：sic-&gt;sick 、改：box-&gt;fox、删：black-&gt;lack、换:act-&gt;cat</p>
<p>（只能更改一个字符）</p>
<img src="/2023/03/24/ElasticSearch/38.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">

<img src="/2023/03/24/ElasticSearch/39.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h3 id="4、聚合查询"><a href="#4、聚合查询" class="headerlink" title="4、聚合查询"></a>4、聚合查询</h3><h5 id="（1）桶（Bucket）聚合"><a href="#（1）桶（Bucket）聚合" class="headerlink" title="（1）桶（Bucket）聚合"></a>（1）桶（Bucket）聚合</h5><blockquote>
<ol>
<li><p>桶：类似于MySQL中的groud by查询后的分组，是存放满足特定条件文档的集合；</p>
</li>
<li><p>指标：对桶中的文档进行计算，类似于MySQL中的count（），avg（）函数</p>
<img src="/2023/03/24/ElasticSearch/40.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ol>
</blockquote>
<blockquote>
<p>数据准备</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs json">POST /car/_bulk<br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;price&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">10000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;color&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;red&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;make&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;honda&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;sold&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2014-10-28&quot;</span> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;price&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">20000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;color&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;red&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;make&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;honda&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;sold&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2014-11-05&quot;</span> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;price&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">30000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;color&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;green&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;make&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ford&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;sold&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2014-05-18&quot;</span> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;price&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">15000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;color&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;blue&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;make&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;toyota&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;sold&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2014-07-02&quot;</span> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;price&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">12000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;color&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;green&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;make&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;toyota&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;sold&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2014-08-19&quot;</span> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;price&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">20000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;color&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;red&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;make&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;honda&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;sold&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2014-11-05&quot;</span> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;price&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">80000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;color&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;red&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;make&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;bmw&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;sold&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2014-01-01&quot;</span> <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;index&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">&#123;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">&#123;</span> <span class="hljs-attr">&quot;price&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-number">25000</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;color&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;blue&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;make&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;ford&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">&quot;sold&quot;</span> <span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;2014-02-12&quot;</span> <span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<h6 id="①普通的聚合查询"><a href="#①普通的聚合查询" class="headerlink" title="①普通的聚合查询"></a>①普通的聚合查询</h6><blockquote>
<p>以汽车中的颜色进行分组聚合，doc_count：表示组数据的数量，每个桶的数量代表改颜色文档数量</p>
<img src="/2023/03/24/ElasticSearch/41.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="②嵌套聚合查询"><a href="#②嵌套聚合查询" class="headerlink" title="②嵌套聚合查询"></a>②嵌套聚合查询</h6><blockquote>
<p>在一个聚合查询到数据，再进行聚合，如下面先以color属性聚合数据，然后在每个桶中再聚合price数据求平均值，如下图：</p>
<img src="/2023/03/24/ElasticSearch/42.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="③filter过滤"><a href="#③filter过滤" class="headerlink" title="③filter过滤"></a>③filter过滤</h6><blockquote>
<p>filter过滤条件，查询指定的数据进行聚合，如下</p>
<img src="/2023/03/24/ElasticSearch/43.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<blockquote>
<p>filters:对filter进行分组聚合，filters中条件进行过滤，将过滤后相同的数据聚合</p>
<img src="/2023/03/24/ElasticSearch/44.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="④range聚合"><a href="#④range聚合" class="headerlink" title="④range聚合"></a>④range聚合</h6><blockquote>
<p>对number类型进行聚合，根据范围值进行聚合，to不包括值。from包括值</p>
<img src="/2023/03/24/ElasticSearch/45.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="⑤Date-Range聚合"><a href="#⑤Date-Range聚合" class="headerlink" title="⑤Date Range聚合"></a>⑤Date Range聚合</h6><blockquote>
<p>对日期进行聚合,from和to后面的参数需要按照我们指定的format格式进行输入</p>
<img src="/2023/03/24/ElasticSearch/46.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="⑥Histogram聚合"><a href="#⑥Histogram聚合" class="headerlink" title="⑥Histogram聚合"></a>⑥Histogram聚合</h6><blockquote>
<ol>
<li><p>histogram 桶要求两个参数：一个数值字段以、一个定义桶大小间隔。</p>
</li>
<li><p>可以使用各种嵌套聚合，来计算对应区间数据</p>
<img src="/2023/03/24/ElasticSearch/47.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ol>
</blockquote>
<h5 id="（2）metrics聚合"><a href="#（2）metrics聚合" class="headerlink" title="（2）metrics聚合"></a>（2）metrics聚合</h5><h6 id="①单值分析：stat类型"><a href="#①单值分析：stat类型" class="headerlink" title="①单值分析：stat类型"></a>①单值分析：stat类型</h6><blockquote>
<ul>
<li><p>avg：求指定字段平均值</p>
<img src="/2023/03/24/ElasticSearch/48.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>max：求指定字段最大值，min：求指定字段最小值</p>
<img src="/2023/03/24/ElasticSearch/49.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>sum：求指定字段总和</p>
<img src="/2023/03/24/ElasticSearch/50.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>value_count：求所有统计数量</p>
<img src="/2023/03/24/ElasticSearch/51.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<h6 id="②单值分析：其他类型"><a href="#②单值分析：其他类型" class="headerlink" title="②单值分析：其他类型"></a>②单值分析：其他类型</h6><blockquote>
<ul>
<li><p>weighted_avg：带权重，求平均值，如：a权重为0.3,b权重为0.7，求平均值：（0.3<em>a+0.7</em>b）&#x2F; 2</p>
<img src="/2023/03/24/ElasticSearch/52.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>cardinality：指定字段，根据字段值去重</p>
<img src="/2023/03/24/ElasticSearch/53.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>median_absolute_deviation：指定字段求中位数</p>
<img src="/2023/03/24/ElasticSearch/54.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<h6 id="③非单值分析：stats"><a href="#③非单值分析：stats" class="headerlink" title="③非单值分析：stats"></a>③非单值分析：stats</h6><blockquote>
<ul>
<li><p>stats包括max、min、avg、sum</p>
<img src="/2023/03/24/ElasticSearch/55.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>matrix_stats：描述字段之间的关系，针对矩阵模型，count：统计数量，mean：平均值</p>
<img src="/2023/03/24/ElasticSearch/56.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>extended_stat：指定字段，汇总该字段的所有信息</p>
<img src="/2023/03/24/ElasticSearch/57.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<h6 id="④非单值分析：百分型"><a href="#④非单值分析：百分型" class="headerlink" title="④非单值分析：百分型"></a>④非单值分析：百分型</h6><blockquote>
<ul>
<li><p>percentiles：根据指定字段计算百分比</p>
<img src="/2023/03/24/ElasticSearch/58.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>percentile_ranks：指定字段和值，统计该值内数值在总体占比，如下：</p>
<img src="/2023/03/24/ElasticSearch/59.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<h6 id="⑤非单值分析：地理位置型"><a href="#⑤非单值分析：地理位置型" class="headerlink" title="⑤非单值分析：地理位置型"></a>⑤非单值分析：地理位置型</h6><blockquote>
<ul>
<li><p>geo_bounds：查找指定位置的坐标范围</p>
<img src="/2023/03/24/ElasticSearch/60.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<h5 id="（3）Pipeline聚合"><a href="#（3）Pipeline聚合" class="headerlink" title="（3）Pipeline聚合"></a>（3）Pipeline聚合</h5><blockquote>
<p>上一步的·聚合结果成为下一个聚合的输入</p>
</blockquote>
<h6 id="①Average聚合"><a href="#①Average聚合" class="headerlink" title="①Average聚合"></a>①Average聚合</h6><blockquote>
<p>在上一个bucket聚合的结果作为输入，输入到metrics聚合中求平均值</p>
<img src="/2023/03/24/ElasticSearch/61.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h3 id="5、原理分析"><a href="#5、原理分析" class="headerlink" title="5、原理分析"></a>5、原理分析</h3><blockquote>
<ul>
<li><p>一个ElasticSearch集群下，有多个node节点组成；</p>
</li>
<li><p>每个node节点上有多个分片，分为主分片和复制分片，主分片会将数据同步给复制分片；</p>
</li>
<li><p>一个分片对应一个Lucence Index索引结构；</p>
</li>
<li><p>一个Lucence Index上有多个Segment（即倒排索引），每个Segment存储文件即为文档数据；</p>
<img src="/2023/03/24/ElasticSearch/62.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<h5 id="（1）Lucence"><a href="#（1）Lucence" class="headerlink" title="（1）Lucence"></a>（1）Lucence</h5><h6 id="①Segment"><a href="#①Segment" class="headerlink" title="①Segment"></a>①Segment</h6><blockquote>
<ul>
<li>Shard&#x3D;Lucene Index</li>
<li>Lucene Index的Segment存放多种数据结构：<ol>
<li>Inverted Index（倒排索引）：分为两部分：一个有序的数据字典（单词term和出现频率）和与term对应的Posting列表（存放单词的文件），如：查询hello world时，将其分为hello和world两个单词，组成倒排索引（如下表）</li>
<li>自动补全：如果要查找以‘c’开头的词，会进行二分查找；</li>
<li>全表查找：查找包含‘our’字母的单词，会进行全表查询；</li>
<li>Document Values：列式存储，大大提升访问速度</li>
</ol>
</li>
</ul>
</blockquote>
<table>
<thead>
<tr>
<th>Dictionary</th>
<th>Posting List</th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>term</td>
<td>freq</td>
<td>documents</td>
</tr>
<tr>
<td>choice</td>
<td>1</td>
<td>2，3，4</td>
</tr>
<tr>
<td>come</td>
<td>4</td>
<td>3，5，6</td>
</tr>
<tr>
<td>hello</td>
<td>2</td>
<td>6，7，8</td>
</tr>
<tr>
<td>ours</td>
<td>3</td>
<td>4，7，8</td>
</tr>
</tbody></table>
<h6 id="②搜索中"><a href="#②搜索中" class="headerlink" title="②搜索中"></a>②搜索中</h6><blockquote>
<ol>
<li><p>搜索每一个segament，然后合并搜索结果；</p>
</li>
<li><p>Segment是不可变的，删除时，数据依旧保存在文件中，只是标记为删除；更新时，先删除，然后重新索引</p>
</li>
<li><p>Lucence会对存储数据进行压缩；</p>
</li>
<li><p>lecence会缓存所有数据，提高查询效率；</p>
<img src="/2023/03/24/ElasticSearch/63.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ol>
</blockquote>
<h6 id="③缓存"><a href="#③缓存" class="headerlink" title="③缓存"></a>③缓存</h6><blockquote>
<ol>
<li>索引文件时，会对文件建立缓存，并定期刷新数据；</li>
<li>随着数据的增多，会产生大量segment，增加索引文件时，会将segment合并，删除</li>
</ol>
</blockquote>
<h5 id="（2）Shard"><a href="#（2）Shard" class="headerlink" title="（2）Shard"></a>（2）Shard</h5><blockquote>
<ol>
<li>Shard可能分布在不同的节点机器上，搜索返回结果会在网络中传输；</li>
<li>每个节点都会存储一份路由表，记录节点上shard信息等，请求到任何节点，都可以转发到对应的shard上的node节点；</li>
</ol>
</blockquote>
<h5 id="（3）Es分析器"><a href="#（3）Es分析器" class="headerlink" title="（3）Es分析器"></a>（3）Es分析器</h5><blockquote>
<p>①分为三部分：</p>
<ul>
<li>字符串过滤器：字符串分词前，将HTML标签去掉，替换&amp;为and；</li>
<li>分词器：将字符串分为一个个单词，简单的分词器，遇到空格或标点符号就会分词；</li>
<li>Token过滤器：将分好的词按顺序进入过滤，可能会改变词，如：小写化，删除无用词条，增加同义词条</li>
</ul>
<p>②内置分词器：</p>
<p>例子：Hello world （5）</p>
<ul>
<li>标准分析器：es默认分词器，根据Unicode定义的单词边界划分文本，去除大部分标点符号，最后词条小写，如【hello，world，5】；</li>
<li>简单分析器：任何不是字母的地方进行分词，最后词条小写，如【hello，world】；</li>
<li>空格分析器：以空格划分文本，如【Hello，world，（5）】；</li>
<li>语言分析器：会将无用单词删除，同时提取英语的词干，如</li>
</ul>
<p>I am watching TV and doing homework–&gt;【I，am，watch，TV，do，homework】</p>
</blockquote>
<h5 id="（4）索引原理"><a href="#（4）索引原理" class="headerlink" title="（4）索引原理"></a>（4）索引原理</h5><h6 id="①文档索引创建流程"><a href="#①文档索引创建流程" class="headerlink" title="①文档索引创建流程"></a>①文档索引创建流程</h6><blockquote>
<ul>
<li><p>客户端发送创建索引请求转发到node1节点；</p>
</li>
<li><p>根据文档id确定文档分片属于p2，请求转发到Node3；</p>
</li>
<li><p>Node3索引数据创建成功，请求转发到Node1，Node2副分片节点上，所有节点创建成功，Node3向协调节点报告成功，协调节点向客户端报告成功；</p>
<img src="/2023/03/24/ElasticSearch/64.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<h6 id="②索引流程"><a href="#②索引流程" class="headerlink" title="②索引流程"></a>②索引流程</h6><blockquote>
<ul>
<li>协调节点通过文档id，计算请求对应的分片，请求转发到对应的节点分片上；</li>
<li>分片接收到请求后，会将请求数据写入到Memory Buffer中，每隔一秒更新到FileSystem缓存中；</li>
<li>缓存中的数据可能会丢失，所以每次请求会写入进Transaction日志中（保证可靠性），当缓存数据写入磁盘时，会清除transaction日志；</li>
<li>transaction日志flush过程中，会将数据刷新到磁盘，同时内容写入一个新的transaction日志中，删除原来的日志，flush每30分钟执行一次，或日志文件大小超过512M时也会触发；</li>
</ul>
<p>transLog日志，对未提交的数据，保证对未提交的数据可以通过id实时访问到</p>
<img src="/2023/03/24/ElasticSearch/65.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch">
</blockquote>
<h6 id="③数据持久化过程"><a href="#③数据持久化过程" class="headerlink" title="③数据持久化过程"></a>③数据持久化过程</h6><blockquote>
<p>主要步骤：write—refresh—flush—merge</p>
<ul>
<li>write：一个新文档会被写入到内存缓冲区中，同时也会写入transLog日志中，此时文档还未写入Segment中，所以是搜索不到新文档的，需要refresh后才能搜索到，Commit point记录所有segment元信息</li>
<li><img src="/2023/03/24/ElasticSearch/66.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>refresh：每隔一秒执行一次刷新，将数据写入到segment中，segment存储在内存中，且可以在segment中搜索到数据，刷新后，清空内存缓冲区数据；该阶段可能会发送数据丢失</p>
<img src="/2023/03/24/ElasticSearch/67.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>flush：每隔30分钟或translog日志文件过大时，就会刷新，创建新的translog日志，删除旧日志；</p>
</li>
<li><ul>
<li><p>所有内存缓冲区的数据被写入Segment中；</p>
</li>
<li><p>内存缓冲区被清空；</p>
</li>
<li><p>将commit point中所有数据写入到磁盘中；</p>
</li>
<li><p>此时索引数据已经写入磁盘，已经持久化，因此不需要原日志数据保证数据安全，清除原translog日志；</p>
<img src="/2023/03/24/ElasticSearch/68.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</li>
</ul>
</blockquote>
<blockquote>
<ul>
<li><p>Merge：每秒刷新会创建大量segment，而搜索时会必须轮询每一个段，段越多，搜索效率越差。es后台会将小段合并，大段合并到更大的段，refresh时，会创建新的段，从已有段选取大小合适的段，与新段合并，然后删除旧的段；</p>
<img src="/2023/03/24/ElasticSearch/69.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>
<h5 id="（5）读取文档流程"><a href="#（5）读取文档流程" class="headerlink" title="（5）读取文档流程"></a>（5）读取文档流程</h5><blockquote>
<ul>
<li><p>初始查询阶段，查询会广播道每一个分片，每一个分片在本地执行搜索，并构建一个匹配文档大小的from+size队列（文档查询是在FileSystem Cache中查询，可能存在Memory Buffer有数据未刷新到FileSystem Cache中，所以是近实时查询）；</p>
</li>
<li><p>每一个分片返回各自的队列，队列中存储文档id，协调节点的队列合并这些分片返回的队列，生成一个全局排序的队列；</p>
</li>
<li><p>协调节点分辨出那个文档要取回阶段，根据文档id获取文档完整数据，返回给客户端；</p>
<img src="/2023/03/24/ElasticSearch/70.png" srcset="/img/loading.gif" lazyload class="" title="ElasticSearch"></li>
</ul>
</blockquote>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>ElasticSearch</div>
      <div>http://example.com/2023/03/24/ElasticSearch/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>swt</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2023年3月24日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/03/31/RabbitMQ%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" title="RabbitMQ学习笔记">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">RabbitMQ学习笔记</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2023/03/18/java%E9%81%97%E4%BC%A0%E7%AE%97%E6%B3%95%E7%BB%84%E5%8D%B7/" title="Java遗传算法组卷">
                        <span class="hidden-mobile">Java遗传算法组卷</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
